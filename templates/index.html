<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Submission and Video Recording</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>

    <div class="container">
        <h2>Document Submission and Video Recording</h2>
        <div class="input-group">
            <div class="upload-box">
                <div class="drag-drop-text">Drag & Drop Your Document Here or Paste Text Below</div>
                <button class="browse-btn">Browse File</button>
                <input type="file" class="file-input" onchange="handleFileUpload(this.files)">
            </div>
            <textarea class="text-area" placeholder="Paste your text here" oninput="handleTextInput()"></textarea>
        </div>
        <div class="webcam-container">
            <video id="webcam" autoplay></video>
            <button class="record-btn" onclick="startRecording()">Start Recording</button>
            <button class="stop-btn" onclick="stopRecording()">Stop Recording</button>
            <div class="record-progress" id="recordProgress"></div>
            <div class="timer" id="timer">00:00</div>
        </div>
    </div>

    <script>
        let progressInterval, recordingTime, maxRecordingTime = 15000;

        function handleFileUpload(files) {
            // File upload code...
            showWebcam();
        }

        function handleTextInput() {
            // Text input code...
            showWebcam();
        }

        function showWebcam() {
            document.getElementById('webcam').style.display = 'block';
            document.querySelector('.record-btn').style.display = 'inline-block';
            document.querySelector('.stop-btn').style.display = 'inline-block';
            startWebcam();
        }

        function startWebcam() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    const video = document.getElementById('webcam');
                    video.srcObject = stream;
                    video.play();
                })
                .catch(err => {
                    console.error('Error accessing the webcam', err);
                });
        }

        let mediaRecorder;
        let recordedBlobs;

        function handleDataAvailable(event) {
            if (event.data && event.data.size > 0) {
                recordedBlobs.push(event.data);
            }
        }

        function startRecording() {
            document.querySelector('.record-btn').disabled = true;
            recordedBlobs = [];
            const video = document.getElementById('webcam');
            let stream = video.srcObject;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start();

            // Start the progress indicator
            const recordProgress = document.getElementById('recordProgress');
            const timer = document.getElementById('timer');
            recordProgress.style.width = '0%';
            recordingTime = 0;
            timer.textContent = '00:00';
            progressInterval = setInterval(() => {
                recordingTime += 1000;
                const progress = (recordingTime / maxRecordingTime) * 100;
                recordProgress.style.width = progress + '%';
                let seconds = Math.floor((recordingTime / 1000) % 60);
                let minutes = Math.floor((recordingTime / (1000 * 60)) % 60);
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (recordingTime >= maxRecordingTime) {
                    clearInterval(progressInterval);
                    stopRecording();
                }
            }, 1000);
        }

        function stopRecording() {
            document.querySelector('.record-btn').disabled = false;
            mediaRecorder.stop();
            clearInterval(progressInterval); // Stop the progress indicator
            const blob = new Blob(recordedBlobs, { type: 'video/webm' });

            // New code to send the recorded video to the Flask endpoint
            const formData = new FormData();
            formData.append('video', blob);

            fetch('/video', {
                method: 'POST',
                body: formData
            }).then(response => {
                return response.text();
            }).then(data => {
                console.log(data);
                // Handle server response here
            }).catch(error => {
                console.error('Error sending the video:', error);
            });

            // Stop all video streams
            const video = document.getElementById('webcam');
            video.srcObject.getTracks().forEach(track => track.stop());
        }


        const uploadBox = document.querySelector('.upload-box');
        uploadBox.addEventListener('dragover', (event) => {
            event.preventDefault();
            // Add styling to indicate drag is over this area
        });

        uploadBox.addEventListener('drop', (event) => {
            event.preventDefault();
            const files = event.dataTransfer.files;
            uploadFile(files);
        });
    </script>

</body>

</html>